name: Recreate Guild Card (Complete)

on:
  workflow_dispatch:
    inputs:
      usuario:
        description: 'Usu√°rio do GitHub (ex: ciconha)'
        required: true
        default: 'ciconha'
      empresa:
        description: 'Nome da empresa (ex: TechLabs Studio)'
        required: false
        default: 'INSS'
      cargo:
        description: 'Cargo atual (ex: Desenvolvedor Back-end)'
        required: false
        default: 'Estagi√°rio de TI'

permissions:
  contents: write

env:
  OUTPUT_DIR: cards
  OUTPUT_SVG: ${{ env.OUTPUT_DIR }}/recreated_card.svg
  OUTPUT_CSV: ${{ env.OUTPUT_DIR }}/recreated_card.csv

jobs:
  validate:
    name: Validate Manual Trigger
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      - name: Confirm manual run
        run: |
          echo "‚úÖ Workflow disparado manualmente com sucesso"
          echo "Inputs:"
          echo "  usuario: ${{ github.event.inputs.usuario }}"
          echo "  empresa: ${{ github.event.inputs.empresa }}"
          echo "  cargo: ${{ github.event.inputs.cargo }}"

  gerar-card:
    name: Gerar SVG e CSV do Guild Card
    runs-on: ubuntu-latest
    needs: validate
    env:
      API_TOKEN: ${{ secrets.TSUKUYOMI_CICONHA }}
      OUTPUT_DIR: ${{ env.OUTPUT_DIR }}
      OUTPUT_SVG: ${{ env.OUTPUT_SVG }}
      OUTPUT_CSV: ${{ env.OUTPUT_CSV }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install system deps
        run: |
          sudo apt-get update -y
          sudo apt-get install -y curl jq

      - name: Fetch GitHub data and prepare variables
        id: fetch-data
        run: |
          # Token fallback: prefer secret TSUKUYOMI_CICONHA, sen√£o usar GITHUB_TOKEN
          if [ -n "${{ env.API_TOKEN }}" ]; then
            TOKEN="${{ env.API_TOKEN }}"
          else
            TOKEN="${{ secrets.GITHUB_TOKEN }}"
          fi

          if [ -z "$TOKEN" ]; then
            echo "ERROR: No token available. Set secrets.TSUKUYOMI_CICONHA or rely on GITHUB_TOKEN."
            exit 1
          fi

          USER="${{ github.event.inputs.usuario || 'ciconha' }}"
          echo "Collecting data for user: $USER"

          curl -s -H "Authorization: token $TOKEN" "https://api.github.com/users/$USER" > user.json || true
          curl -s -H "Authorization: token $TOKEN" "https://api.github.com/users/$USER/repos?per_page=100&sort=updated" > repos.json || true
          curl -s -H "Authorization: token $TOKEN" "https://api.github.com/users/$USER/events?per_page=100" > events.json || true

          sanitize() { echo "$1" | iconv -c -t UTF-8//TRANSLIT | tr -d '\n' | sed 's/"/\\"/g'; }

          LOGIN=$(jq -r '.login // empty' user.json || echo "$USER")
          NAME=$(jq -r '.name // empty' user.json); NAME=${NAME:-$LOGIN}; NAME=$(sanitize "$NAME")
          BIO=$(jq -r '.bio // empty' user.json); BIO=${BIO:-"Desenvolvedor apaixonado por tecnologia."}; BIO=$(sanitize "$BIO")
          REPOS=$(jq -r '.public_repos // 0' user.json || echo 0)
          FOLLOWERS=$(jq -r '.followers // 0' user.json || echo 0)
          COMMITS=$(jq '[.[] | select(.type == "PushEvent")] | length' events.json 2>/dev/null || echo 0)
          PRS=$(jq '[.[] | select(.type == "PullRequestEvent")] | length' events.json 2>/dev/null || echo 0)
          ISSUES=$(jq '[.[] | select(.type == "IssuesEvent")] | length' events.json 2>/dev/null || echo 0)
          LANG=$(jq -r '.[].language' repos.json 2>/dev/null | grep -v null | sort | uniq -c | sort -nr | head -1 | awk '{print $2}' || true)
          LANG=${LANG:-"N√£o especificada"}

          TOTAL_XP=$((REPOS * 50 + FOLLOWERS * 30 + COMMITS * 2 + PRS * 10 + ISSUES * 5))
          LEVEL=$((TOTAL_XP / 1000 + 1)); [ $LEVEL -lt 1 ] && LEVEL=1
          XP_PERCENTAGE=$(( (TOTAL_XP % 1000) * 100 / 1000 )); [ $XP_PERCENTAGE -lt 0 ] && XP_PERCENTAGE=0

          if [ "$REPOS" -gt 100 ]; then CLASS="Lend√°rio"
          elif [ "$REPOS" -gt 50 ]; then CLASS="√âpico"
          elif [ "$FOLLOWERS" -gt 100 ]; then CLASS="Lenda"
          else CLASS="Aventureiro"; fi

          if [ "$REPOS" -gt 100 ]; then RANK="Lend√°rio"
          elif [ "$REPOS" -gt 50 ]; then RANK="√âpico"
          else RANK="Her√≥i"; fi

          jq 'sort_by(-.stargazers_count) | [.[0:2] | .[] | {name: .name, stars: (.stargazers_count // 0)}]' repos.json > top_projects.json 2>/dev/null || echo '[]' > top_projects.json

          echo "login=$LOGIN" >> $GITHUB_OUTPUT
          echo "name=$NAME" >> $GITHUB_OUTPUT
          echo "bio=$BIO" >> $GITHUB_OUTPUT
          echo "repos=$REPOS" >> $GITHUB_OUTPUT
          echo "followers=$FOLLOWERS" >> $GITHUB_OUTPUT
          echo "commits=$COMMITS" >> $GITHUB_OUTPUT
          echo "prs=$PRS" >> $GITHUB_OUTPUT
          echo "issues=$ISSUES" >> $GITHUB_OUTPUT
          echo "lang=$LANG" >> $GITHUB_OUTPUT
          echo "total_xp=$TOTAL_XP" >> $GITHUB_OUTPUT
          echo "level=$LEVEL" >> $GITHUB_OUTPUT
          echo "xp_percentage=$XP_PERCENTAGE" >> $GITHUB_OUTPUT
          echo "class=$CLASS" >> $GITHUB_OUTPUT
          echo "rank=$RANK" >> $GITHUB_OUTPUT

      - name: Generate SVG and CSV
        run: |
          mkdir -p "${OUTPUT_DIR}"
          USERNAME="${{ steps.fetch-data.outputs.login }}"
          NAME="${{ steps.fetch-data.outputs.name }}"
          BIO="${{ steps.fetch-data.outputs.bio }}"
          REPOS="${{ steps.fetch-data.outputs.repos }}"
          FOLLOWERS="${{ steps.fetch-data.outputs.followers }}"
          COMMITS="${{ steps.fetch-data.outputs.commits }}"
          PRS="${{ steps.fetch-data.outputs.prs }}"
          ISSUES="${{ steps.fetch-data.outputs.issues }}"
          LANG="${{ steps.fetch-data.outputs.lang }}"
          TOTAL_XP="${{ steps.fetch-data.outputs.total_xp }}"
          LEVEL="${{ steps.fetch-data.outputs.level }}"
          XP_PERCENTAGE="${{ steps.fetch-data.outputs.xp_percentage }}"
          CLASS="${{ steps.fetch-data.outputs.class }}"
          RANK="${{ steps.fetch-data.outputs.rank }}"
          EMPRESA="${{ github.event.inputs.empresa }}"
          CARGO="${{ github.event.inputs.cargo }}"
          PROJECT1_NAME=$(jq -r '.[0].name // "Sem projetos"' top_projects.json 2>/dev/null)
          PROJECT1_STARS=$(jq -r '.[0].stars // 0' top_projects.json 2>/dev/null)
          PROJECT2_NAME=$(jq -r '.[1].name // "Sem projetos"' top_projects.json 2>/dev/null)
          PROJECT2_STARS=$(jq -r '.[1].stars // 0' top_projects.json 2>/dev/null)
          CURRENT_DATE=$(date +'%d/%m/%Y')
          BAR_WIDTH=$((400 * XP_PERCENTAGE / 100)); [ $BAR_WIDTH -gt 400 ] && BAR_WIDTH=400

          SVG_FILE="${OUTPUT_DIR}/${USERNAME}.svg"
          cat > "$SVG_FILE" <<EOF
<svg xmlns="http://www.w3.org/2000/svg" width="460" height="280" viewBox="0 0 460 280">
  <defs>
    <linearGradient id="darkRedBg" x1="0%" y1="0%" x2="100%" y2="100%">
      <stop offset="0%" stop-color="#1a0000"/>
      <stop offset="50%" stop-color="#360000"/>
      <stop offset="100%" stop-color="#1a0000"/>
    </linearGradient>
    <style>
      @import url('https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700;900&family=Share+Tech+Mono&display=swap');
      .title { font-family: 'Orbitron', monospace; font-size: 24px; font-weight: 900; fill: #FF2222; }
      .subtitle { font-family: 'Orbitron', monospace; font-size: 12px; fill: #FF6666; }
      .text { font-family: 'Share Tech Mono', monospace; font-size: 11px; fill: #FFAAAA; }
      .tech { font-family: 'Share Tech Mono', monospace; font-size: 10px; fill: #FF8888; }
      .bar-bg { fill: #0a0000; }
      .bar-fill { fill: #ff3333; }
    </style>
  </defs>

  <rect width="460" height="280" rx="15" ry="15" fill="url(#darkRedBg)" stroke="#880000" stroke-width="2"/>
  <g>
    <text x="30" y="55" class="title">${NAME}</text>
    <text x="30" y="75" class="subtitle">[ ${EMPRESA} ] ‚Ä¢ { ${CARGO} }</text>
    <text x="30" y="93" class="subtitle">[ ${CLASS} ] ‚Ä¢ { ${RANK} }</text>
    <rect x="25" y="105" width="410" height="35" rx="5" fill="#110000" opacity="0.5" stroke="#330000" stroke-width="1"/>
    <text x="30" y="125" class="text">"${BIO}"</text>

    <rect x="25" y="150" width="200" height="60" rx="8" fill="#0a0000" opacity="0.7" stroke="#440000" stroke-width="1"/>
    <text x="35" y="170" class="tech">‚ö° TECH STACK:</text>
    <text x="35" y="190" class="subtitle">${LANG}</text>

    <rect x="235" y="150" width="200" height="60" rx="8" fill="#0a0000" opacity="0.7" stroke="#440000" stroke-width="1"/>
    <text x="245" y="170" class="tech">üéÆ PLAYER STATS:</text>
    <text x="245" y="190" class="subtitle">LVL ${LEVEL} ‚Ä¢ XP ${TOTAL_XP}</text>

    <text x="30" y="235" class="tech">PROGRESSO [ ${XP_PERCENTAGE}% ]:</text>
    <rect x="30" y="240" width="400" height="12" class="bar-bg" rx="6" ry="6"/>
    <rect x="30" y="240" width="${BAR_WIDTH}" height="12" class="bar-fill" rx="6" ry="6"/>

    <rect x="25" y="255" width="410" height="40" rx="5" fill="#110000" opacity="0.6" stroke="#330000" stroke-width="1"/>
    <text x="30" y="272" class="subtitle">‚≠ê PROJECT HIGHLIGHTS:</text>
    <text x="35" y="290" class="text">¬ª ${PROJECT1_NAME} ‚Äî ‚≠ê${PROJECT1_STARS}</text>
    <text x="230" y="290" class="text">¬ª ${PROJECT2_NAME} ‚Äî ‚≠ê${PROJECT2_STARS}</text>

    <text x="230" y="320" text-anchor="middle" class="tech">[ ${CURRENT_DATE} ] ‚Ä¢ COMMITS:${COMMITS} ‚Ä¢ PRs:${PRS} ‚Ä¢ ISSUES:${ISSUES}</text>
  </g>
</svg>
EOF

          CSV_FILE="${OUTPUT_DIR}/${USERNAME}.csv"
          echo "username,name,repos,followers,commits,prs,issues,lang,level,total_xp,xp_percentage,class,rank,date" > "$CSV_FILE"
          echo "${USERNAME},\"${NAME}\",${REPOS},${FOLLOWERS},${COMMITS},${PRS},${ISSUES},\"${LANG}\",${LEVEL},${TOTAL_XP},${XP_PERCENTAGE},${CLASS},${RANK},${CURRENT_DATE}" >> "$CSV_FILE"

          echo "SVG gerado: $SVG_FILE"
          echo "CSV gerado: $CSV_FILE"

      - name: List generated files
        run: |
          ls -la "${OUTPUT_DIR}" || true
          echo "---- SVG preview ----"
          head -n 40 "${OUTPUT_DIR}"/*.svg || true
          echo "---- CSV preview ----"
          cat "${OUTPUT_DIR}"/*.csv || true

      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: guild-card-assets
          path: "${OUTPUT_DIR}/"

      - name: Optional commit back to repo
        if: ${{ github.ref == 'refs/heads/' + github.repository_owner || always() }}
        run: |
          git config user.name "github-actions"
          git config user.email "github-actions@github.com"
          if git status --porcelain | grep -q "${OUTPUT_DIR}/"; then
            git add "${OUTPUT_DIR}/"
            git commit -m "üé® Atualiza√ß√£o do cart√£o da guilda para ${{ github.event.inputs.usuario || 'ciconha' }}"
            git push origin HEAD || echo "Push falhou (verifique permiss√µes)"
          else
            echo "Nenhuma mudan√ßa para commitar."
          fi
