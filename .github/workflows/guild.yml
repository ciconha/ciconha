name: 🏰 Guild Card Generator

on:
  workflow_dispatch:
    inputs:
      username:
        description: "GitHub username"
        required: true
        default: "ciconha"

permissions:
  contents: write

jobs:
  gerar-cartao:
    runs-on: ubuntu-latest

    steps:
      - name: 🧩 Checkout do repositório
        uses: actions/checkout@v4

      - name: 📦 Instalar dependências
        run: |
          sudo apt-get update
          sudo apt-get install -y curl jq

      - name: 🔍 Buscar dados do GitHub
        id: dados
        run: |
          USER="${{ github.event.inputs.username }}"
          curl -s "https://api.github.com/users/$USER" > user.json

          LOGIN=$(jq -r '.login' user.json)
          NAME=$(jq -r '.name // .login' user.json)
          BIO=$(jq -r '.bio // "Desbravador da Guilda"' user.json)
          AVATAR=$(jq -r '.avatar_url' user.json)
          REPOS=$(jq -r '.public_repos' user.json)
          FOLLOWERS=$(jq -r '.followers' user.json)
          CREATED=$(jq -r '.created_at' user.json | cut -d'T' -f1)

          echo "login=$LOGIN" >> $GITHUB_OUTPUT
          echo "name=$NAME" >> $GITHUB_OUTPUT
          echo "bio=$BIO" >> $GITHUB_OUTPUT
          echo "avatar=$AVATAR" >> $GITHUB_OUTPUT
          echo "repos=$REPOS" >> $GITHUB_OUTPUT
          echo "followers=$FOLLOWERS" >> $GITHUB_OUTPUT
          echo "created=$CREATED" >> $GITHUB_OUTPUT

      - name: 🎨 Gerar SVG do Cartão
        run: |
          mkdir -p cards
          DATE=$(date +'%d/%m/%Y')

          LOGIN="${{ steps.dados.outputs.login }}"
          NAME="${{ steps.dados.outputs.name }}"
          BIO="${{ steps.dados.outputs.bio }}"
          AVATAR="${{ steps.dados.outputs.avatar }}"
          REPOS="${{ steps.dados.outputs.repos }}"
          FOLLOWERS="${{ steps.dados.outputs.followers }}"
          CREATED="${{ steps.dados.outputs.created }}"

          cat > cards/$LOGIN.svg <<EOF
<svg xmlns="http://www.w3.org/2000/svg" width="500" height="200">
  <style>
    .title { font: bold 20px sans-serif; fill: #fff; }
    .text { font: 14px sans-serif; fill: #ccc; }
    .label { font: 12px sans-serif; fill: #999; }
  </style>
  <rect width="100%" height="100%" fill="#1a1a2e"/>
  <image href="$AVATAR" x="20" y="20" width="60" height="60" />
  <text x="100" y="40" class="title">$NAME</text>
  <text x="100" y="65" class="text">@${LOGIN}</text>
  <text x="100" y="85" class="label">$BIO</text>
  <text x="20" y="120" class="text">📦 Repositórios: $REPOS</text>
  <text x="20" y="140" class="text">👥 Seguidores: $FOLLOWERS</text>
  <text x="20" y="160" class="text">📅 Desde: $CREATED</text>
  <text x="250" y="190" class="label">Gerado em $DATE • GuildCard</text>
</svg>
EOF

      - name: 💾 Commit e Push
        run: |
          git config user.name "github-actions"
          git config user.email "github-actions@github.com"
          git add cards/
          git commit -m "🧙‍♂️ Cartão gerado para ${{ github.event.inputs.username }}"
          git push
