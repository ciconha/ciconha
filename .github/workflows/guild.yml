name: guild.yml Workflow

on:
  workflow_dispatch:
    inputs:
      usuario:
        description: "Usu√°rio do GitHub"
        required: true
        default: "ciconha"

permissions:
  contents: write

jobs:
  gerar-cartao:
    runs-on: ubuntu-latest

    steps:
      - name: üß© Checkout do reposit√≥rio
        uses: actions/checkout@v4

      - name: üì¶ Instalar depend√™ncias
        run: |
          sudo apt-get update
          sudo apt-get install -y curl jq

      - name: üîç Buscar dados do GitHub
        id: fetch-data
        run: |
          USER="${{ github.event.inputs.usuario }}"
          curl -s "https://api.github.com/users/$USER" > user.json
          curl -s "https://api.github.com/users/$USER/repos?sort=stars&per_page=100" > repos.json
          curl -s "https://api.github.com/users/$USER/events?per_page=100" > events.json

          LOGIN=$(jq -r '.login' user.json)
          AVATAR=$(jq -r '.avatar_url' user.json)
          REPOS=$(jq -r '.public_repos' user.json)
          FOLLOWERS=$(jq -r '.followers' user.json)
          COMMITS=$(jq '[.[] | select(.type=="PushEvent")] | length' events.json)
          PRS=$(jq '[.[] | select(.type=="PullRequestEvent")] | length' events.json)
          ISSUES=$(jq '[.[] | select(.type=="IssuesEvent")] | length' events.json)

          TOTAL_XP=$((REPOS * 50 + FOLLOWERS * 30 + COMMITS * 2 + PRS * 10 + ISSUES * 5))
          LEVEL=$((TOTAL_XP / 1000 + 1))
          XP_PERCENTAGE=$(( (TOTAL_XP % 1000) * 100 / 1000 ))

          echo "login=$LOGIN" >> $GITHUB_OUTPUT
          echo "avatar=$AVATAR" >> $GITHUB_OUTPUT
          echo "total_xp=$TOTAL_XP" >> $GITHUB_OUTPUT
          echo "level=$LEVEL" >> $GITHUB_OUTPUT
          echo "xp_percentage=$XP_PERCENTAGE" >> $GITHUB_OUTPUT

      - name: üé® Gerar Cart√£o SVG Recheado
        run: |
          mkdir -p cards
          DATE=$(date +'%d/%m/%Y')

          AVATAR="${{ steps.fetch-data.outputs.avatar }}"
          LOGIN="${{ steps.fetch-data.outputs.login }}"
          LEVEL="${{ steps.fetch-data.outputs.level }}"
          XP="${{ steps.fetch-data.outputs.xp_percentage }}"

          echo '<svg xmlns="http://www.w3.org/2000/svg" width="460" height="300">' > cards/ciconha.svg
          echo '<rect width="460" height="300" rx="20" fill="#f0f4f8" stroke="#4a90e2" stroke-width="4"/>' >> cards/ciconha.svg
          echo "<image href='${AVATAR}' x='20' y='20' width='80' height='80' clip-path='circle(40px at 40px 40px)'/>" >> cards/ciconha.svg
          echo "<text x='120' y='50' font-size='22' font-weight='bold'>${LOGIN}</text>" >> cards/ciconha.svg
          echo "<text x='120' y='75' font-size='14'>Nv. ${LEVEL} ‚Ä¢ üöÄ Lenda Fullstack</text>" >> cards/ciconha.svg
          echo "<text x='120' y='95' font-size='12'>FULLSTACK ‚Ä¢ INSS ‚Ä¢ 20 anos</text>" >> cards/ciconha.svg
          echo "<rect x='120' y='110' width='300' height='15' rx='8' fill='#ddd'/>" >> cards/ciconha.svg
          echo "<rect x='120' y='110' width='${XP*3}' height='15' rx='8' fill='#4caf50'/>" >> cards/ciconha.svg
          echo "<text x='270' y='123' font-size='11' text-anchor='middle'>XP: ${XP}%</text>" >> cards/ciconha.svg
          echo "<text x='230' y='280' text-anchor='middle' font-size='11'>Gerado em ${DATE}</text>" >> cards/ciconha.svg
          echo '</svg>' >> cards/ciconha.svg

      - name: üíæ Commit e Push
        run: |
          git config user.name "github-actions"
          git config user.email "github-actions@github.com"
          git add cards/
          git commit -m "üßô‚Äç‚ôÇÔ∏è Cart√£o da guilda gerado para ciconha" || echo "Nada para commitar"
          git push
