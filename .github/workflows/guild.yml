name: Guild Card SVG

on:
  schedule:
    - cron: "0 0 * * *"  # Executa todo dia √† meia-noite
  workflow_dispatch:
    inputs:
      usuario:
        description: 'GitHub username'
        required: true
        default: 'ciconha'

permissions:
  contents: write

jobs:
  gerar-svg:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout do reposit√≥rio
        uses: actions/checkout@v4

      - name: Instalar depend√™ncias
        run: |
          sudo apt-get update
          sudo apt-get install -y curl jq

      - name: Buscar dados do GitHub
        id: fetch-data
        run: |
          USER="${{ github.event.inputs.usuario }}"
          curl -s "https://api.github.com/users/$USER" > user.json
          curl -s "https://api.github.com/users/$USER/repos?sort=stars&per_page=100" > repos.json
          curl -s "https://api.github.com/users/$USER/events?per_page=100" > events.json

          LOGIN=$(jq -r '.login' user.json)
          AVATAR=$(jq -r '.avatar_url' user.json)
          REPOS=$(jq -r '.public_repos' user.json)
          FOLLOWERS=$(jq -r '.followers' user.json)
          USER_ID=$(jq -r '.id' user.json)

          COMMITS=$(jq '[.[] | select(.type == "PushEvent")] | length' events.json)
          PRS=$(jq '[.[] | select(.type == "PullRequestEvent")] | length' events.json)
          ISSUES=$(jq '[.[] | select(.type == "IssuesEvent")] | length' events.json)

          TOTAL_XP=$((REPOS * 50 + FOLLOWERS * 30 + COMMITS * 2 + PRS * 10 + ISSUES * 5))
          LEVEL=$((TOTAL_XP / 1000 + 1))
          XP_PERCENTAGE=$(( (TOTAL_XP % 1000) * 100 / 1000 ))
          XP_BAR=$(( 200 * XP_PERCENTAGE / 100 ))

          TOTAL_STARS=$(jq '[.[] | .stargazers_count] | add' repos.json)

          jq 'sort_by(-.stargazers_count) | .[0:2] | .[] | {name: .name, description: (.description // "Sem descri√ß√£o"), stars: .stargazers_count}' repos.json > top_projects.json

          if [ $REPOS -gt 50 ]; then CLASS="Arquiteto"
          elif [ $FOLLOWERS -gt 100 ]; then CLASS="Lenda"
          elif [ $REPOS -gt 30 ] && [ $FOLLOWERS -gt 50 ]; then CLASS="Mestre"
          else CLASS="Aventureiro"; fi

          if [ $REPOS -gt 100 ]; then RANK="Lend√°rio"
          elif [ $REPOS -gt 50 ]; then RANK="√âpico"
          else RANK="Her√≥i"; fi

          echo "login=$LOGIN" >> $GITHUB_OUTPUT
          echo "avatar=$AVATAR" >> $GITHUB_OUTPUT
          echo "repos=$REPOS" >> $GITHUB_OUTPUT
          echo "followers=$FOLLOWERS" >> $GITHUB_OUTPUT
          echo "user_id=$USER_ID" >> $GITHUB_OUTPUT
          echo "commits=$COMMITS" >> $GITHUB_OUTPUT
          echo "prs=$PRS" >> $GITHUB_OUTPUT
          echo "issues=$ISSUES" >> $GITHUB_OUTPUT
          echo "total_xp=$TOTAL_XP" >> $GITHUB_OUTPUT
          echo "level=$LEVEL" >> $GITHUB_OUTPUT
          echo "xp_percentage=$XP_PERCENTAGE" >> $GITHUB_OUTPUT
          echo "xp_bar=$XP_BAR" >> $GITHUB_OUTPUT
          echo "class=$CLASS" >> $GITHUB_OUTPUT
          echo "rank=$RANK" >> $GITHUB_OUTPUT
          echo "total_stars=$TOTAL_STARS" >> $GITHUB_OUTPUT

      - name: Gerar SVG do cart√£o
        run: |
          mkdir -p cards
          DATE=$(date +'%d/%m/%Y')

          P1_NAME=$(jq -r '.name' top_projects.json | head -1)
          P1_DESC=$(jq -r '.description' top_projects.json | head -1)
          P1_STARS=$(jq -r '.stars' top_projects.json | head -1)

          P2_NAME=$(jq -r '.name' top_projects.json | tail -1)
          P2_DESC=$(jq -r '.description' top_projects.json | tail -1)
          P2_STARS=$(jq -r '.stars' top_projects.json | tail -1)

          cat > cards/${{ github.event.inputs.usuario }}.svg <<EOF
<svg xmlns="http://www.w3.org/2000/svg" width="450" height="280">
  <style>
    .title { font: bold 20px sans-serif; fill: #333; }
    .text { font: 14px sans-serif; fill: #555; }
    .small { font: 12px sans-serif; fill: #777; }
  </style>
  <rect width="100%" height="100%" fill="#fdf6e3" stroke="#8b5e3c" stroke-width="3" rx="15"/>
  <image href="${{ steps.fetch-data.outputs.avatar }}" x="20" y="20" width="60" height="60" clip-path="circle(30px at 50px 50px)"/>
  <text x="100" y="40" class="title">${{ steps.fetch-data.outputs.login }}</text>
  <text x="100" y="65" class="text">Nv. ${{ steps.fetch-data.outputs.level }} ‚Ä¢ ${{ steps.fetch-data.outputs.class }} ‚Ä¢ ${{ steps.fetch-data.outputs.rank }}</text>
  <text x="100" y="85" class="small">Reposit√≥rios: ${{ steps.fetch-data.outputs.repos }} ‚Ä¢ Seguidores: ${{ steps.fetch-data.outputs.followers }}</text>
  <text x="100" y="105" class="small">XP: ${{ steps.fetch-data.outputs.total_xp }} ‚Ä¢ ${{ steps.fetch-data.outputs.xp_percentage }}%</text>
  <rect x="100" y="110" width="200" height="10" fill="#ddd" rx="5"/>
  <rect x="100" y="110" width="${{ steps.fetch-data.outputs.xp_bar }}" height="10" fill="#4caf50" rx="5"/>
  <text x="20" y="140" class="text">‚≠ê Total de estrelas: ${{ steps.fetch-data.outputs.total_stars }}</text>
  <text x="20" y="160" class="title">Projetos em destaque:</text>
  <text x="20" y="180" class="text">‚Ä¢ $P1_NAME ‚Äî $P1_DESC (${P1_STARS}‚≠ê)</text>
  <text x="20" y="200" class="text">‚Ä¢ $P2_NAME ‚Äî $P2_DESC (${P2_STARS}‚≠ê)</text>
  <text x="225" y="260" text-anchor="middle" class="small">Cart√£o da Guilda ‚Ä¢ $DATE</text>
</svg>
EOF

      - name: Commit e Push
        run: |
          git config user.name "github-actions"
          git config user.email "github-actions@github.com"
          git add cards/
          git commit -m "üßô‚Äç‚ôÇÔ∏è Cart√£o SVG gerado para ${{ github.event.inputs.usuario }}"
          git push
