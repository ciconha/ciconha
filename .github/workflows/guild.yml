name: Guild Card SVG

on:
  workflow_dispatch:
    inputs:
      usuario:
        description: 'ciconha'
        required: true
        default: 'ciconha'

permissions:
  contents: write

jobs:
  gerar-svg:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout do repositorio
        uses: actions/checkout@v4

      - name: Instalar dependencias
        run: |
          sudo apt-get update
          sudo apt-get install -y curl jq

      - name: Buscar dados do GitHub
        id: fetch-data
        run: |
          # Buscar dados do usuario
          curl -s -H "Authorization: token ${{ secrets.GITHUB_TOKEN }}" \
            "https://api.github.com/users/${{ github.event.inputs.usuario }}" > user.json
          
          # Buscar repositorios
          curl -s -H "Authorization: token ${{ secrets.GITHUB_TOKEN }}" \
            "https://api.github.com/users/${{ github.event.inputs.usuario }}/repos?sort=stars&per_page=100" > repos.json
          
          # Buscar eventos para commits, PRs e issues
          curl -s -H "Authorization: token ${{ secrets.GITHUB_TOKEN }}" \
            "https://api.github.com/users/${{ github.event.inputs.usuario }}/events?per_page=100" > events.json
          
          # Processar dados
          LOGIN=$(jq -r '.login' user.json)
          AVATAR=$(jq -r '.avatar_url' user.json)
          REPOS=$(jq -r '.public_repos' user.json)
          FOLLOWERS=$(jq -r '.followers' user.json)
          USER_ID=$(jq -r '.id' user.json)
          
          # Calcular commits, PRs e issues dos eventos
          COMMITS=$(jq '[.[] | select(.type == "PushEvent")] | length' events.json)
          PRS=$(jq '[.[] | select(.type == "PullRequestEvent")] | length' events.json)
          ISSUES=$(jq '[.[] | select(.type == "IssuesEvent")] | length' events.json)
          
          # Calcular XP e nivel
          TOTAL_XP=$((REPOS * 50 + FOLLOWERS * 30 + COMMITS * 2 + PRS * 10 + ISSUES * 5))
          LEVEL=$((TOTAL_XP / 1000 + 1))
          XP_PERCENTAGE=$(( (TOTAL_XP % 1000) * 100 / 1000 ))
          
          # Buscar top 2 projetos com mais stars
          jq 'sort_by(-.stargazers_count) | .[0:2] | .[] | {name: .name, description: (.description // "Sem descricao"), stars: .stargazers_count}' repos.json > top_projects.json
          
          # Determinar classe baseada no perfil
          if [ $REPOS -gt 50 ]; then
            CLASS="Arquiteto"
          elif [ $FOLLOWERS -gt 100 ]; then
            CLASS="Lenda"
          elif [ $REPOS -gt 30 ] && [ $FOLLOWERS -gt 50 ]; then
            CLASS="Mestre"
          else
            CLASS="üöÄ Lenda Fullstack"
          fi
          
          # Determinar rank
          if [ $REPOS -gt 100 ]; then
            RANK="Lendario"
          elif [ $REPOS -gt 50 ]; then
            RANK="Epico"
          else
            RANK="Heroi"
          fi
          
          # Salvar todas as variaveis
          echo "login=$LOGIN" >> $GITHUB_OUTPUT
          echo "avatar=$AVATAR" >> $GITHUB_OUTPUT
          echo "repos=$REPOS" >> $GITHUB_OUTPUT
          echo "followers=$FOLLOWERS" >> $GITHUB_OUTPUT
          echo "user_id=$USER_ID" >> $GITHUB_OUTPUT
          echo "commits=$COMMITS" >> $GITHUB_OUTPUT
          echo "prs=$PRS" >> $GITHUB_OUTPUT
          echo "issues=$ISSUES" >> $GITHUB_OUTPUT
          echo "total_xp=$TOTAL_XP" >> $GITHUB_OUTPUT
          echo "level=$LEVEL" >> $GITHUB_OUTPUT
          echo "xp_percentage=$XP_PERCENTAGE" >> $GITHUB_OUTPUT
          echo "class=$CLASS" >> $GITHUB_OUTPUT
          echo "rank=$RANK" >> $GITHUB_OUTPUT

      - name: Gerar SVG do cartao
        run: |
          mkdir -p cards
          
          # Ler projetos do arquivo JSON
          PROJECT1_NAME=$(jq -r '.name' top_projects.json | head -1)
          PROJECT1_DESC=$(jq -r '.description' top_projects.json | head -1)
          PROJECT1_STARS=$(jq -r '.stars' top_projects.json | head -1)
          
          PROJECT2_NAME=$(jq -r '.name' top_projects.json | tail -1)
          PROJECT2_DESC=$(jq -r '.description' top_projects.json | tail -1)
          PROJECT2_STARS=$(jq -r '.stars' top_projects.json | tail -1)
          
          # Data atual
          CURRENT_DATE=$(date +'%d/%m/%Y')
          
          # Informacoes do formulario
          USER_AGE="20"
          USER_COMPANY="INSS"
          USER_AREA="fullstack"
          
          cat > cards/${{ github.event.inputs.usuario }}.svg << EOF
<svg xmlns="http://www.w3.org/2000/svg" width="450" height="280" viewBox="0 0 450 280">
  <defs>
    <style>
      .card { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; }
      .title { font-size: 22px; font-weight: bold; fill: #8B4513; }
      .subtitle { font-size: 14px; fill: #654321; }
      .text { font-size: 12px; fill: #5D4037; }
      .xp-text { font-size: 10px; fill: #795548; }
      .project-title { font-size: 11px; font-weight: bold; fill: #5D4037; }
      .project-desc { font-size: 10px; fill: #795548; }
      .stat { font-size: 11px; fill: #5D4037; }
    </style>
    <linearGradient id="bgGradient" x1="0%" y1="0%" x2="100%" y2="100%">
      <stop offset="0%" stop-color="#F5F5DC" />
      <stop offset="100%" stop-color="#DEB887" />
    </linearGradient>
    <linearGradient id="xpGradient" x1="0%" y1="0%" x2="100%" y2="0%">
      <stop offset="0%" stop-color="#FFD700" />
      <stop offset="100%" stop-color="#FFA500" />
    </linearGradient>
  </defs>
  
  <!-- Fundo do cartao -->
  <rect width="450" height="280" fill="url(#bgGradient)" rx="15" ry="15" stroke="#8B4513" stroke-width="3"/>
  
  <!-- Avatar -->
  <defs>
    <clipPath id="avatarClip">
      <circle cx="75" cy="75" r="30"/>
    </clipPath>
  </defs>
  <image href="${{ steps.fetch-data.outputs.avatar }}" x="45" y="45" width="60" height="60" clip-path="url(#avatarClip)"/>
  
  <!-- Informacoes principais -->
  <text x="150" y="60" class="title">${{ steps.fetch-data.outputs.login }}</text>
  <text x="150" y="80" class="subtitle">Nv. ${{ steps.fetch-data.outputs.level }} - ${{ steps.fetch-data.outputs.repos }} ano (${{ steps.fetch-data.outputs.followers }}) no GH-${{ steps.fetch-data.outputs.user_id }}</text>
  
  <!-- Barra de XP -->
  <text x="150" y="100" class="xp-text">${{ steps.fetch-data.outputs.total_xp }} XP ‚Ä¢ ${{ steps.fetch-data.outputs.xp_percentage }}% para o proximo nivel</text>
  <rect x="150" y="105" width="200" height="8" fill="#E0E0E0" rx="4" ry="4"/>
  <rect x="150" y="105" width="$(( 200 * ${{ steps.fetch-data.outputs.xp_percentage }} / 100 ))" height="8" fill="url(#xpGradient)" rx="4" ry="4"/>
  
  <!-- Status -->
  <text x="150" y="125" class="stat">‚Ä¢ Classe: ${{ steps.fetch-data.outputs.class }}</text>
  <text x="150" y="140" class="stat">‚Ä¢ Rank: ${{ steps.fetch-data.outputs.rank }}</text>
  <text x="150" y="155" class="stat">‚Ä¢ Capacidade: ${{ steps.fetch-data.outputs.followers }}</text>
  
  <!-- Informacoes Profissionais -->
  <text x="150" y="175" class="stat">üè¢ Empresa: ${USER_COMPANY}</text>
  <text x="150" y="190" class="stat">üéØ Area: ${USER_AREA}</text>
  <text x="150" y="205" class="stat">üìÖ Idade: ${USER_AGE} anos</text>
  
  <!-- Atividades -->
  <text x="30" y="220" class="subtitle">Atividades: ${{ steps.fetch-data.outputs.commits }} commits + ${{ steps.fetch-data.outputs.prs }} PRs + ${{ steps.fetch-data.outputs.issues }} issues</text>
  
  <!-- Projetos Destacados -->
  <text x="30" y="240" class="title">Projetos Destacados:</text>
  <text x="30" y="255" class="project-title">‚Ä¢ ${PROJECT1_NAME}</text>
  <text x="30" y="270" class="project-desc">${PROJECT1_DESC}</text>
  <text x="30" y="285" class="project-desc">‚≠ê ${PROJECT1_STARS} estrelas</text>
  
  <text x="230" y="255" class="project-title">‚Ä¢ ${PROJECT2_NAME}</text>
  <text x="230" y="270" class="project-desc">${PROJECT2_DESC}</text>
  <text x="230" y="285" class="project-desc">‚≠ê ${PROJECT2_STARS} estrelas</text>
  
  <!-- Rodape -->
  <text x="225" y="310" text-anchor="middle" class="text">Cartao da Guilda RPG ‚Ä¢ Gerado em ${CURRENT_DATE}</text>
</svg>
EOF
          
          echo "Cartao SVG gerado para ${{ github.event.inputs.usuario }}"

      - name: Commit e Push
        run: |
          git config user.name "github-actions"
          git config user.email "github-actions@github.com"
          git add cards/
          git commit -m "Cartao SVG da guilda gerado para ${{ github.event.inputs.usuario }}"
          git push
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

# ‚öôÔ∏è Configuracoes:
# ‚Ä¢ Usuario: ciconha
# ‚Ä¢ Classe: üöÄ Lenda Fullstack
# ‚Ä¢ Empresa: INSS
# ‚Ä¢ Area: fullstack
# ‚Ä¢ Idade: 20
#
# üìÅ Cartao salvo em: cards/ciconha.svg
#
# ‚ö†Ô∏è INSTRUCOES:
# 1. Salve como .github/workflows/guild.yml
# 2. Garanta permissao do GITHUB_TOKEN
# 3. Execute em Actions ‚Üí Guild Card
