name: guild

on:
  workflow_dispatch:
    inputs:
      username:
        description: "GitHub username para gerar o cart√£o"
        required: true
        default: "ciconha"
        type: string

permissions:
  contents: write

jobs:
  build:
    runs-on: ubuntu-latest
    name: üè∞ Gerar Cart√£o da Guilda
    
    steps:
      - name: üß© Checkout do reposit√≥rio
        uses: actions/checkout@v4

      - name: üì¶ Instalar depend√™ncias
        run: |
          sudo apt-get update
          sudo apt-get install -y curl jq

      - name: üîç Buscar dados do GitHub
        id: dados
        run: |
          USER="${{ github.event.inputs.username }}"
          echo "üîç Coletando dados para: $USER"
          
          curl -s "https://api.github.com/users/$USER" > user.json
          curl -s "https://api.github.com/users/$USER/events?per_page=100" > events.json

          LOGIN=$(jq -r '.login' user.json)
          NAME=$(jq -r '.name // .login' user.json)
          BIO=$(jq -r '.bio // "Aventureiro da Guilda"' user.json)
          AVATAR=$(jq -r '.avatar_url' user.json)
          REPOS=$(jq -r '.public_repos' user.json)
          FOLLOWERS=$(jq -r '.followers' user.json)
          FOLLOWING=$(jq -r '.following' user.json)
          CREATED=$(jq -r '.created_at' user.json | cut -d'T' -f1)

          COMMITS=$(jq '[.[] | select(.type=="PushEvent")] | length' events.json)
          PRS=$(jq '[.[] | select(.type=="PullRequestEvent")] | length' events.json)
          ISSUES=$(jq '[.[] | select(.type=="IssuesEvent")] | length' events.json)

          XP=$((REPOS * 50 + FOLLOWERS * 30 + COMMITS * 2 + PRS * 10 + ISSUES * 5))
          LEVEL=$((XP / 1000 + 1))
          XP_BAR=$((XP % 1000 * 450 / 1000))
          XP_PCT=$((XP % 1000 * 100 / 1000))

          if [ $XP -lt 300 ]; then
            CLASS="üå± Novato"
            COLOR="#48bb78"
          elif [ $XP -lt 600 ]; then
            CLASS="‚öîÔ∏è Guerreiro"
            COLOR="#4299e1"
          elif [ $XP -lt 1000 ]; then
            CLASS="üî• Avan√ßado"
            COLOR="#ed8936"
          else
            CLASS="üèÜ Lenda"
            COLOR="#f6e05e"
          fi

          echo "login=$LOGIN" >> $GITHUB_OUTPUT
          echo "name=$NAME" >> $GITHUB_OUTPUT
          echo "bio=$BIO" >> $GITHUB_OUTPUT
          echo "avatar=$AVATAR" >> $GITHUB_OUTPUT
          echo "repos=$REPOS" >> $GITHUB_OUTPUT
          echo "followers=$FOLLOWERS" >> $GITHUB_OUTPUT
          echo "following=$FOLLOWING" >> $GITHUB_OUTPUT
          echo "created=$CREATED" >> $GITHUB_OUTPUT
          echo "commits=$COMMITS" >> $GITHUB_OUTPUT
          echo "prs=$PRS" >> $GITHUB_OUTPUT
          echo "issues=$ISSUES" >> $GITHUB_OUTPUT
          echo "xp=$XP" >> $GITHUB_OUTPUT
          echo "level=$LEVEL" >> $GITHUB_OUTPUT
          echo "xp_bar=$XP_BAR" >> $GITHUB_OUTPUT
          echo "xp_pct=$XP_PCT" >> $GITHUB_OUTPUT
          echo "class=$CLASS" >> $GITHUB_OUTPUT
          echo "class_color=$COLOR" >> $GITHUB_OUTPUT

      - name: üé® Gerar SVG do Cart√£o
        run: |
          mkdir -p cards
          DATE=$(date +'%d/%m/%Y')

          LOGIN="${{ steps.dados.outputs.login }}"
          NAME="${{ steps.dados.outputs.name }}"
          BIO="${{ steps.dados.outputs.bio }}"
          AVATAR="${{ steps.dados.outputs.avatar }}"
          REPOS="${{ steps.dados.outputs.repos }}"
          FOLLOWERS="${{ steps.dados.outputs.followers }}"
          FOLLOWING="${{ steps.dados.outputs.following }}"
          CREATED="${{ steps.dados.outputs.created }}"
          COMMITS="${{ steps.dados.outputs.commits }}"
          PRS="${{ steps.dados.outputs.prs }}"
          ISSUES="${{ steps.dados.outputs.issues }}"
          XP="${{ steps.dados.outputs.xp }}"
          LEVEL="${{ steps.dados.outputs.level }}"
          XP_BAR="${{ steps.dados.outputs.xp_bar }}"
          XP_PCT="${{ steps.dados.outputs.xp_pct }}"
          CLASS="${{ steps.dados.outputs.class }}"
          CLASS_COLOR="${{ steps.dados.outputs.class_color }}"

          cat > cards/$LOGIN.svg << 'EOF'
<svg xmlns="http://www.w3.org/2000/svg" width="500" height="280" viewBox="0 0 500 280">
  <defs>
    <linearGradient id="bgGradient" x1="0%" y1="0%" x2="100%" y2="100%">
      <stop offset="0%" stop-color="#1a1a2e"/>
      <stop offset="100%" stop-color="#16213e"/>
    </linearGradient>
    <clipPath id="avatarClip">
      <circle cx="50" cy="50" r="40"/>
    </clipPath>
  </defs>

  <rect width="500" height="280" rx="15" fill="url(#bgGradient)"/>
  
  <image href="${AVATAR}" x="15" y="15" width="80" height="80" clip-path="url(#avatarClip)"/>

  <text x="110" y="35" font-family="Arial, sans-serif" font-size="18" font-weight="bold" fill="#ffffff">
    ${NAME}
  </text>
  <text x="110" y="55" font-family="Arial, sans-serif" font-size="12" fill="#e2e8f0">
    @${LOGIN}
  </text>
  <text x="110" y="72" font-family="Arial, sans-serif" font-size="10" fill="#a0aec0">
    ${BIO}
  </text>

  <g transform="translate(350, 25)">
    <rect width="130" height="40" rx="8" fill="rgba(255,255,255,0.1)"/>
    <text x="65" y="15" text-anchor="middle" font-family="Arial, sans-serif" font-size="11" font-weight="bold" fill="${CLASS_COLOR}">
      ${CLASS}
    </text>
    <text x="65" y="30" text-anchor="middle" font-family="Arial, sans-serif" font-size="10" fill="#ffffff">
      N√≠vel ${LEVEL}
    </text>
  </g>

  <g transform="translate(25, 110)">
    <text x="0" y="0" font-family="Arial, sans-serif" font-size="11" fill="#e2e8f0">
      PROGRESSO ‚Ä¢ ${XP} XP
    </text>
    <rect x="0" y="8" width="450" height="15" rx="7" fill="#2d3748"/>
    <rect x="0" y="8" width="${XP_BAR}" height="15" rx="7" fill="${CLASS_COLOR}"/>
    <text x="225" y="19" text-anchor="middle" font-family="Arial, sans-serif" font-size="9" fill="#ffffff" font-weight="bold">
      ${XP_PCT}% at√© n√≠vel ${LEVEL}
    </text>
  </g>

  <g transform="translate(25, 140)">
    <rect width="450" height="80" rx="10" fill="rgba(255,255,255,0.05)"/>
    
    <g transform="translate(20, 15)">
      <text x="0" y="0" font-family="Arial, sans-serif" font-size="12" font-weight="bold" fill="#48bb78">${REPOS}</text>
      <text x="0" y="15" font-family="Arial, sans-serif" font-size="9" fill="#a0aec0">Reposit√≥rios</text>
    </g>

    <g transform="translate(120, 15)">
      <text x="0" y="0" font-family="Arial, sans-serif" font-size="12" font-weight="bold" fill="#4299e1">${FOLLOWERS}</text>
      <text x="0" y="15" font-family="Arial, sans-serif" font-size="9" fill="#a0aec0">Seguidores</text>
    </g>

    <g transform="translate(220, 15)">
      <text x="0" y="0" font-family="Arial, sans-serif" font-size="12" font-weight="bold" fill="#ed8936">${COMMITS}</text>
      <text x="0" y="15" font-family="Arial, sans-serif" font-size="9" fill="#a0aec0">Commits</text>
    </g>

    <g transform="translate(320, 15)">
      <text x="0" y="0" font-family="Arial, sans-serif" font-size="12" font-weight="bold" fill="#9f7aea">${PRS}</text>
      <text x="0" y="15" font-family="Arial, sans-serif" font-size="9" fill="#a0aec0">Pull Requests</text>
    </g>

    <g transform="translate(20, 50)">
      <text x="0" y="0" font-family="Arial, sans-serif" font-size="12" font-weight="bold" fill="#f56565">${ISSUES}</text>
      <text x="0" y="15" font-family="Arial, sans-serif" font-size="9" fill="#a0aec0">Issues</text>
    </g>

    <g transform="translate(120, 50)">
      <text x="0" y="0" font-family="Arial, sans-serif" font-size="12" font-weight="bold" fill="#38b2ac">${FOLLOWING}</text>
      <text x="0" y="15" font-family="Arial, sans-serif" font-size="9" fill="#a0aec0">Seguindo</text>
    </g>

    <g transform="translate(220, 50)">
      <text x="0" y="0" font-family="Arial, sans-serif" font-size="12" font-weight="bold" fill="#f6e05e">${CREATED}</text>
      <text x="0" y="15" font-family="Arial, sans-serif" font-size="9" fill="#a0aec0">Desde</text>
    </g>
  </g>

  <text x="250" y="270" text-anchor="middle" font-family="Arial, sans-serif" font-size="9" fill="#718096">
    üè∞ Guild Card ‚Ä¢ ${DATE} ‚Ä¢ github.com/${LOGIN}
  </text>
</svg>
EOF

      - name: üíæ Commit e Push
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add cards/
          git commit -m "üè∞ Cart√£o da guilda para ${{ github.event.inputs.username }}" || echo "Nada para commitar"
          git push

      - name: üì¶ Upload artefato
        uses: actions/upload-artifact@v4
        with:
          name: guild-card
          path: cards/
          retention-days: 7
