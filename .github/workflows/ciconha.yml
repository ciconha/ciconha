// ==============================
// üß® CICONHA CHAOS CARD Generator v3.0
// ==============================
class ChaosCardGenerator {
    constructor() {
        this.formData = {};
    }

    collectFormData() {
        this.formData = {
            username: document.getElementById('username')?.value.trim() || 'ciconha',
            token: document.getElementById('token')?.value.trim() || 'GITHUB_TOKEN',
            workflowName: document.getElementById('workflowName')?.value.trim() || 'ciconha-chaos-card'
        };
        return this.formData;
    }

    validateForm() {
        const d = this.formData;
        if (!d.username) return this.showToast('‚ùå Nome de usu√°rio GitHub √© obrigat√≥rio!', 'error');
        return true;
    }

    generateChaosYAML() {
        const d = this.formData;

        return `name: üß® CICONHA CHAOS CARD

on:
  schedule:
    - cron: "0 3 * * 1" # Toda segunda-feira √†s 03h UTC
  workflow_dispatch:
    inputs:
      usuario:
        description: "Seu nome de usu√°rio GitHub"
        required: true
        default: "${d.username}"

permissions:
  contents: write

jobs:
  chaos-card:
    runs-on: ubuntu-latest
    steps:
      - name: Preparar ambiente
        run: |
          sudo apt-get update -y
          sudo apt-get install -y curl jq

      - name: üîç Coletar dados do GitHub
        id: collect
        run: |
          USER="\${{ github.event.inputs.usuario }}"
          echo "Coletando dados para: $USER"
          curl -s "https://api.github.com/users/$USER" > user.json
          curl -s "https://api.github.com/users/$USER/repos?sort=stars&per_page=100" > repos.json
          curl -s "https://api.github.com/users/$USER/events?per_page=100" > events.json

          LOGIN=$(jq -r '.login // empty' user.json)
          NAME=$(jq -r '.name // empty' user.json)
          BIO=$(jq -r '.bio // empty' user.json | sed 's/"/\\"/g')
          AVATAR=$(jq -r '.avatar_url // empty' user.json)
          REPOS=$(jq -r '.public_repos // 0' user.json)
          FOLLOWERS=$(jq -r '.followers // 0' user.json)
          CREATED=$(jq -r '.created_at // empty' user.json)

          COMMITS=$(jq '[.[] | select(.type == "PushEvent")] | length' events.json)
          PRS=$(jq '[.[] | select(.type == "PullRequestEvent")] | length' events.json)
          ISSUES=$(jq '[.[] | select(.type == "IssuesEvent")] | length' events.json)
          STARS=$(jq '[.[] | .stargazers_count] | add' repos.json)
          TOP1=$(jq -r 'sort_by(-.stargazers_count) | .[0] // {} | .name' repos.json)
          TOP1_DESC=$(jq -r 'sort_by(-.stargazers_count) | .[0] // {} | (.description // "Sem descri√ß√£o")' repos.json)

          XP=$((REPOS * 50 + FOLLOWERS * 20 + COMMITS * 2 + PRS * 10 + ISSUES * 5))
          LEVEL=$((XP / 1000 + 1))
          XP_PERC=$(( (XP % 1000) * 100 / 1000 ))
          DATE=$(date +'%YÂπ¥%mÊúà%dÊó•')
          STYLE=$((RANDOM % 4))

          echo "STYLE=$STYLE" >> $GITHUB_OUTPUT
          echo "login=$LOGIN" >> $GITHUB_OUTPUT
          echo "name=$NAME" >> $GITHUB_OUTPUT
          echo "bio=$BIO" >> $GITHUB_OUTPUT
          echo "avatar=$AVATAR" >> $GITHUB_OUTPUT
          echo "repos=$REPOS" >> $GITHUB_OUTPUT
          echo "followers=$FOLLOWERS" >> $GITHUB_OUTPUT
          echo "commits=$COMMITS" >> $GITHUB_OUTPUT
          echo "prs=$PRS" >> $GITHUB_OUTPUT
          echo "issues=$ISSUES" >> $GITHUB_OUTPUT
          echo "stars=$STARS" >> $GITHUB_OUTPUT
          echo "top1=$TOP1" >> $GITHUB_OUTPUT
          echo "top1_desc=$TOP1_DESC" >> $GITHUB_OUTPUT
          echo "xp=$XP" >> $GITHUB_OUTPUT
          echo "level=$LEVEL" >> $GITHUB_OUTPUT
          echo "xp_perc=$XP_PERC" >> $GITHUB_OUTPUT
          echo "date=$DATE" >> $GITHUB_OUTPUT

      - name: üé® Gerar SVG ca√≥tico (CICONHA STYLE)
        run: |
          USER="\${{ github.event.inputs.usuario }}"
          mkdir -p chaos
          STYLE=\${{ steps.collect.outputs.STYLE }}
          LOGIN="\${{ steps.collect.outputs.login }}"
          NAME="\${{ steps.collect.outputs.name }}"
          BIO="\${{ steps.collect.outputs.bio }}"
          AVATAR="\${{ steps.collect.outputs.avatar }}"
          REPOS="\${{ steps.collect.outputs.repos }}"
          FOLLOWERS="\${{ steps.collect.outputs.followers }}"
          COMMITS="\${{ steps.collect.outputs.commits }}"
          PRS="\${{ steps.collect.outputs.prs }}"
          ISSUES="\${{ steps.collect.outputs.issues }}"
          STARS="\${{ steps.collect.outputs.stars }}"
          TOP1="\${{ steps.collect.outputs.top1 }}"
          TOP1_DESC="\${{ steps.collect.outputs.top1_desc }}"
          XP="\${{ steps.collect.outputs.xp }}"
          LEVEL="\${{ steps.collect.outputs.level }}"
          XP_PERC="\${{ steps.collect.outputs.xp_perc }}"
          DATE="\${{ steps.collect.outputs.date }}"

          if [ "$STYLE" = "0" ]; then
            BG="#0f1720"; ACC="#FF2E63"; GRA="#08D9D6"
          elif [ "$STYLE" = "1" ]; then
            BG="#14121b"; ACC="#FFD166"; GRA="#06D6A0"
          elif [ "$STYLE" = "2" ]; then
            BG="#ffffff"; ACC="#1b1b1b"; GRA="#e63946"
          else
            BG="#080808"; ACC="#7C4DFF"; GRA="#00E5FF"
          fi

          cat <<EOF > chaos/\${USER}-chaos.svg
<svg xmlns="http://www.w3.org/2000/svg" width="460" height="220">
  <rect width="100%" height="100%" fill="\${BG}" rx="16"/>
  <image href="\${AVATAR}" x="16" y="18" width="68" height="68" clip-path="url(#clip)"/>
  <text x="100" y="40" fill="\${ACC}" font-weight="bold">\${LOGIN}</text>
  <text x="100" y="60" fill="\${GRA}" font-size="12">\${NAME}</text>
  <text x="100" y="80" fill="#999" font-size="10">\${BIO}</text>
  <text x="18" y="160" fill="#ccc" font-size="10">‚≠ê Stars: \${STARS} | üß† XP: \${XP} | LVL \${LEVEL}</text>
  <text x="230" y="210" text-anchor="middle" fill="#888" font-size="10">Êõ¥Êñ∞Êó•: \${DATE} ‚Ä¢ CICONHA CHAOS v1</text>
</svg>
EOF

      - name: üíæ Commit e Push
        run: |
          git config user.name "github-actions"
          git config user.email "github-actions@github.com"
          git add chaos/
          git commit -m "üß® Chaos Card atualizado para \${{ github.event.inputs.usuario }}" || echo "Nada a commitar"
          git push
`;
    }

    previewYAML() {
        this.collectFormData();
        if (!this.validateForm()) return;
        const yaml = this.generateChaosYAML();
        document.getElementById('yamlPreview').textContent = yaml;
        this.showToast('üëÅÔ∏è Preview do Chaos Card pronto!');
    }

    downloadYAML() {
        this.collectFormData();
        if (!this.validateForm()) return;
        const content = this.generateChaosYAML();
        const fileName = `${this.formData.workflowName}.yml`;
        const blob = new Blob([content], { type: 'text/yaml;charset=utf-8' });
        const link = document.createElement('a');
        link.href = URL.createObjectURL(blob);
        link.download = fileName;
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
        URL.revokeObjectURL(link.href);
        this.showToast(`‚ö° ${fileName} baixado com sucesso!`);
    }

    showToast(msg, type = 'success') {
        const toast = document.getElementById('toast');
        toast.textContent = msg;
        toast.className = `toast ${type} show`;
        setTimeout(() => toast.classList.remove('show'), 4000);
    }
}

const chaosGen = new ChaosCardGenerator();

function previewYAML() { chaosGen.previewYAML(); }
function downloadYAML() { chaosGen.downloadYAML(); }

document.addEventListener('DOMContentLoaded', () => {
    document.getElementById('username')?.focus();
    chaosGen.showToast('üß© Chaos Card Generator carregado com sucesso!');
});
