name: üß® CICONHA CHAOS CARD

on:
  schedule:
    - cron: "0 3 * * 1" # Toda segunda-feira √†s 03:00 UTC
  workflow_dispatch:
    inputs:
      usuario:
        description: "Seu nome de usu√°rio GitHub"
        required: true
        default: "ciconha"
      empresa:
        description: "Nome da empresa (opcional)"
        required: false
        default: "Independente"
      cargo:
        description: "Cargo atual (opcional)"
        required: false
        default: "Aventureiro de C√≥digo"

permissions:
  contents: write

jobs:
  chaos-card:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          persist-credentials: true

      - name: Preparar ambiente
        run: |
          set -e
          sudo apt-get update -y
          sudo apt-get install -y curl jq iconv

      - name: üîç Coletar dados do GitHub
        id: collect
        run: |
          set -e
          USER="${{ github.event.inputs.usuario }}"
          TOKEN="${{ secrets.TSUKUYOMI_CICONHA || '' }}"
          echo "Coletando dados para: $USER"

          AUTH=""
          if [ -n "$TOKEN" ]; then
            AUTH="-H \"Authorization: token $TOKEN\""
          fi

          eval "curl -s $AUTH \"https://api.github.com/users/$USER\" > user.json"
          eval "curl -s $AUTH \"https://api.github.com/users/$USER/repos?per_page=100\" > repos.json"
          eval "curl -s $AUTH \"https://api.github.com/users/$USER/events?per_page=100\" > events.json"

          sanitize() {
            echo "$1" | iconv -c -t UTF-8//TRANSLIT | tr -d '\n' | sed 's/"/\\"/g'
          }

          LOGIN=$(jq -r '.login // ""' user.json)
          NAME=$(sanitize "$(jq -r '.name // ""' user.json)")
          BIO=$(sanitize "$(jq -r '.bio // ""' user.json)")
          AVATAR=$(jq -r '.avatar_url // ""' user.json)
          REPOS=$(jq -r '.public_repos // 0' user.json)
          FOLLOWERS=$(jq -r '.followers // 0' user.json)
          CREATED=$(jq -r '.created_at // ""' user.json)

          COMMITS=$(jq '[.[] | select(.type == "PushEvent")] | length' events.json)
          PRS=$(jq '[.[] | select(.type == "PullRequestEvent")] | length' events.json)
          ISSUES=$(jq '[.[] | select(.type == "IssuesEvent")] | length' events.json)
          STARS=$(jq '[.[] | .stargazers_count] | add' repos.json)
          TOP1=$(jq -r 'sort_by(-.stargazers_count) | .[0] // {} | .name' repos.json)
          TOP1_DESC=$(sanitize "$(jq -r 'sort_by(-.stargazers_count) | .[0] // {} | (.description // "Sem descri√ß√£o")' repos.json)")

          TOTAL_XP=$((REPOS * 50 + FOLLOWERS * 20 + COMMITS * 2 + PRS * 10 + ISSUES * 5))
          LEVEL=$((TOTAL_XP / 1000 + 1))
          XP_PERC=$(( (TOTAL_XP % 1000) * 100 / 1000 ))
          DATE=$(date +'%YÂπ¥%mÊúà%dÊó•')

          STYLE=$((RANDOM % 4))

          echo "STYLE=${STYLE}" >> "$GITHUB_OUTPUT"
          echo "login=${LOGIN}" >> "$GITHUB_OUTPUT"
          echo "name=${NAME}" >> "$GITHUB_OUTPUT"
          echo "bio=${BIO}" >> "$GITHUB_OUTPUT"
          echo "avatar=${AVATAR}" >> "$GITHUB_OUTPUT"
          echo "repos=${REPOS}" >> "$GITHUB_OUTPUT"
          echo "followers=${FOLLOWERS}" >> "$GITHUB_OUTPUT"
          echo "commits=${COMMITS}" >> "$GITHUB_OUTPUT"
          echo "prs=${PRS}" >> "$GITHUB_OUTPUT"
          echo "issues=${ISSUES}" >> "$GITHUB_OUTPUT"
          echo "stars=${STARS}" >> "$GITHUB_OUTPUT"
          echo "top1=${TOP1}" >> "$GITHUB_OUTPUT"
          echo "top1_desc=${TOP1_DESC}" >> "$GITHUB_OUTPUT"
          echo "xp=${TOTAL_XP}" >> "$GITHUB_OUTPUT"
          echo "level=${LEVEL}" >> "$GITHUB_OUTPUT"
          echo "xp_perc=${XP_PERC}" >> "$GITHUB_OUTPUT"
          echo "date=${DATE}" >> "$GITHUB_OUTPUT"

      - name: üé® Gerar SVG cyberpunk japon√™s (variante aleat√≥ria)
        run: |
          set -e
          USER="${{ github.event.inputs.usuario }}"
          mkdir -p chaos
          STYLE="${{ steps.collect.outputs.STYLE }}"
          LOGIN="${{ steps.collect.outputs.login }}"
          NAME="${{ steps.collect.outputs.name }}"
          BIO="${{ steps.collect.outputs.bio }}"
          AVATAR="${{ steps.collect.outputs.avatar }}"
          REPOS="${{ steps.collect.outputs.repos }}"
          FOLLOWERS="${{ steps.collect.outputs.followers }}"
          COMMITS="${{ steps.collect.outputs.commits }}"
          PRS="${{ steps.collect.outputs.prs }}"
          ISSUES="${{ steps.collect.outputs.issues }}"
          STARS="${{ steps.collect.outputs.stars }}"
          TOP1="${{ steps.collect.outputs.top1 }}"
          TOP1_DESC="${{ steps.collect.outputs.top1_desc }}"
          XP="${{ steps.collect.outputs.xp }}"
          LEVEL="${{ steps.collect.outputs.level }}"
          XP_PERC="${{ steps.collect.outputs.xp_perc }}"
          DATE="${{ steps.collect.outputs.date }}"
          EMPRESA="${{ github.event.inputs.empresa }}"
          CARGO="${{ github.event.inputs.cargo }}"

          if [ "$STYLE" = "0" ]; then
            BG="#07060a"; ACC="#ff2e63"; GRA="#08d9d6"; FONT="'Noto Sans JP', sans-serif"
            NOISE='<rect x="0" y="0" width="40" height="220" fill="#000" opacity="0.06"/>'
          elif [ "$STYLE" = "1" ]; then
            BG="#0f0b12"; ACC="#ffb86b"; GRA="#7afcff"; FONT="'Noto Sans JP', sans-serif"
            NOISE='<rect x="380" y="0" width="80" height="220" fill="#000" opacity="0.05"/>'
          elif [ "$STYLE" = "2" ]; then
            BG="#0b0d0f"; ACC="#e63946"; GRA="#00f5d4"; FONT="'Yu Gothic', sans-serif"
            NOISE='<g opacity="0.06"><rect x="0" y="0" width="460" height="8" fill="#fff"/></g>'
          else
            BG="#070707"; ACC="#9b6bff"; GRA="#00e6ff"; FONT="'Courier New', monospace"
            NOISE='<rect x="200" y="0" width="260" height="220" fill="#000" opacity="0.03"/>'
          fi

          BAR_TOTAL=140
          FILLED=$(( BAR_TOTAL * XP_PERC / 100 ))

          cat > "chaos/${USER}-chaos.svg" <<EOF
<svg xmlns="http://www.w3.org/2000/svg" width="460" height="220" viewBox="0 0 460 220">
  <style>
    .jp { font: bold 16px ${FONT}; fill: ${ACC}; letter-spacing:0.6px; }
    .graffiti { font: italic 12px ${FONT}; fill: ${GRA}; }
    .label { font: 10px sans-serif; fill: #cfcfcf; }
    .small { font: 9px sans-serif; fill: #a8a8a8; }
    .bg { fill: ${BG}; }
  </style>

  <rect width="100%" height="100%" class="bg" rx="18"/>
  ${NOISE}

  <defs>
    <clipPath id="clip"><circle cx="50" cy="50" r="34"/></clipPath>
  </defs>

  <image href="${AVATAR}" x="16" y="16" width="68" height="68" clip-path="url(#clip)"/>
  <rect x="12" y="12" width="76" height="76" rx="12" fill="none" stroke="${ACC}" stroke-width="1.6" opacity="0.8"/>

  <text x="100" y="36" class="jp">„É¶„Éº„Ç∂„ÉºÔºö${LOGIN}</text>
  <text x="100" y="56" class="small">${NAME} ‚Ä¢ ${EMPRESA}</text>
  <text x="100" y="74" class="label">ËÅ∑Ê•≠Ôºö${CARGO}</text>

  <text x="18" y="104" class="label">${BIO}</text>

  <g transform="translate(18,118)">
    <rect x="0" y="0" rx="6" width="120" height="30" fill="#000" opacity="0.14"/>
    <text x="10" y="19" class="label">„É™„Éù„Ç∏„Éà„É™</text>
    <text x="110" y="19" class="label" text-anchor="end">${REPOS}</text>
  </g>

  <g transform="translate(156,118)">
    <rect x="0" y="0" rx="6" width="116" height="30" fill="#000" opacity="0.12"/>
    <text x="10" y="19" class="label">„Éï„Ç©„É≠„ÉØ„Éº</text>
    <text x="106" y="19" class="label" text-anchor="end">${FOLLOWERS}</text>
  </g>

  <g transform="translate(292,118)">
    <rect x="0" y="0" rx="6" width="150" height="30" fill="#000" opacity="0.10"/>
    <text x="10" y="19" class="label">„Çπ„Çø„ÉºÂêàË®à</text>
    <text x="140" y="19" class="label" text-anchor="end">${STARS}</text>
  </g>

  <text x="18" y="164" class="label">„Ç≥„Éü„ÉÉ„Éà / PR / Issues</text>
  <text x="18" y="182" class="graffiti">${COMMITS} / ${PRS} / ${ISSUES}</text>

  <text x="18" y="202" class="label">„Éà„ÉÉ„Éó: ${TOP1} ‚Äî <tspan class="small">${TOP1_DESC}</tspan></text>

  <rect x="300" y="22" width="${BAR_TOTAL}" height="12" rx="6" fill="#111" opacity="0.5"/>
  <rect x="300" y="22" width="${FILLED}" height="12" rx="6" fill="${ACC}"/>
  <text x="370" y="18" class="small" text-anchor="middle">LV.${LEVEL} ‚Ä¢ XP ${XP}</text>

  <text x="18" y="212" font-size="10" fill="${ACC}">‚ö†Ô∏è „Éä„Éé„Éú„ÉÉ„ÉàÈÅéË≤†Ëç∑ - „Éá„Éº„ÇøÁ†¥ÁâáÂåñ</text>
  <text x="280" y="212" font-size="10" fill="${GRA}">CHAOS MODE ‚Ä¢ Êõ¥Êñ∞Êó•: ${DATE}</text>

</svg>
EOF

          echo "SVG gerado: chaos/${USER}-chaos.svg"

      - name: üìÅ Mostrar arquivo gerado
        run: |
          ls -la chaos || true

      - name: üíæ Commit e Push
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          git config user.name "github-actions"
          git config user.email "github-actions@github.com"
          git add chaos/
          git commit -m "üß® Chaos Card atualizado para ${{ github.event.inputs.usuario }}" || echo "Nada a commitar"
          git push
