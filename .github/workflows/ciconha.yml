// =====================================
// ðŸ§¨ Guild Chaos Workflow Generator v3.0
// =====================================

class ChaosWorkflowGenerator {
    constructor() {
        this.formData = {};
    }

    collectFormData() {
        this.formData = {
            username: document.getElementById('username')?.value.trim() || '',
            workflowName: document.getElementById('workflowName')?.value.trim() || 'chaos-card',
        };
        return this.formData;
    }

    validateForm() {
        const d = this.formData;
        if (!d.username) return this.showToast('âŒ GitHub username Ã© obrigatÃ³rio!', 'error');
        return true;
    }

    generateChaosYAML() {
        const d = this.formData;

        return `name: ðŸ§¨ CICONHA CHAOS CARD

on:
  schedule:
    - cron: "0 3 * * 1" # Toda segunda-feira Ã s 03h UTC
  workflow_dispatch:
    inputs:
      usuario:
        description: "Seu nome de usuÃ¡rio GitHub"
        required: true
        default: "${d.username}"

permissions:
  contents: write

jobs:
  chaos-card:
    runs-on: ubuntu-latest
    steps:
      - name: Preparar ambiente
        run: |
          sudo apt-get update -y
          sudo apt-get install -y curl jq

      - name: ðŸ” Coletar dados do GitHub
        id: collect
        run: |
          USER="\${{ github.event.inputs.usuario }}"
          echo "Coletando dados para: $USER"
          curl -s "https://api.github.com/users/$USER" > user.json
          curl -s "https://api.github.com/users/$USER/repos?sort=stars&per_page=100" > repos.json
          curl -s "https://api.github.com/users/$USER/events?per_page=100" > events.json

          LOGIN=$(jq -r '.login // empty' user.json)
          NAME=$(jq -r '.name // empty' user.json)
          BIO=$(jq -r '.bio // empty' user.json | sed 's/"/\\"/g')
          AVATAR=$(jq -r '.avatar_url // empty' user.json)
          REPOS=$(jq -r '.public_repos // 0' user.json)
          FOLLOWERS=$(jq -r '.followers // 0' user.json)

          COMMITS=$(jq '[.[] | select(.type == "PushEvent")] | length' events.json)
          PRS=$(jq '[.[] | select(.type == "PullRequestEvent")] | length' events.json)
          ISSUES=$(jq '[.[] | select(.type == "IssuesEvent")] | length' events.json)
          STARS=$(jq '[.[] | .stargazers_count] | add' repos.json)
          TOP1=$(jq -r 'sort_by(-.stargazers_count) | .[0] // {} | .name' repos.json)
          TOP1_DESC=$(jq -r 'sort_by(-.stargazers_count) | .[0] // {} | (.description // "Sem descriÃ§Ã£o")' repos.json)

          XP=$((REPOS * 50 + FOLLOWERS * 20 + COMMITS * 2 + PRS * 10 + ISSUES * 5))
          LEVEL=$((XP / 1000 + 1))
          XP_PERC=$(((XP % 1000) * 100 / 1000))
          DATE=$(date +'%Yå¹´%mæœˆ%dæ—¥')
          STYLE=$((RANDOM % 4))

          echo "STYLE=$STYLE" >> $GITHUB_OUTPUT
          echo "login=$LOGIN" >> $GITHUB_OUTPUT
          echo "name=$NAME" >> $GITHUB_OUTPUT
          echo "bio=$BIO" >> $GITHUB_OUTPUT
          echo "avatar=$AVATAR" >> $GITHUB_OUTPUT
          echo "repos=$REPOS" >> $GITHUB_OUTPUT
          echo "followers=$FOLLOWERS" >> $GITHUB_OUTPUT
          echo "commits=$COMMITS" >> $GITHUB_OUTPUT
          echo "prs=$PRS" >> $GITHUB_OUTPUT
          echo "issues=$ISSUES" >> $GITHUB_OUTPUT
          echo "stars=$STARS" >> $GITHUB_OUTPUT
          echo "top1=$TOP1" >> $GITHUB_OUTPUT
          echo "top1_desc=$TOP1_DESC" >> $GITHUB_OUTPUT
          echo "xp=$XP" >> $GITHUB_OUTPUT
          echo "level=$LEVEL" >> $GITHUB_OUTPUT
          echo "xp_perc=$XP_PERC" >> $GITHUB_OUTPUT
          echo "date=$DATE" >> $GITHUB_OUTPUT

      - name: ðŸŽ¨ Gerar SVG caÃ³tico
        run: |
          USER="\${{ github.event.inputs.usuario }}"
          mkdir -p chaos
          STYLE=\${{ steps.collect.outputs.STYLE }}
          AVATAR="\${{ steps.collect.outputs.avatar }}"
          LOGIN="\${{ steps.collect.outputs.login }}"
          NAME="\${{ steps.collect.outputs.name }}"
          BIO="\${{ steps.collect.outputs.bio }}"
          REPOS="\${{ steps.collect.outputs.repos }}"
          FOLLOWERS="\${{ steps.collect.outputs.followers }}"
          STARS="\${{ steps.collect.outputs.stars }}"
          COMMITS="\${{ steps.collect.outputs.commits }}"
          PRS="\${{ steps.collect.outputs.prs }}"
          ISSUES="\${{ steps.collect.outputs.issues }}"
          XP="\${{ steps.collect.outputs.xp }}"
          LEVEL="\${{ steps.collect.outputs.level }}"
          XP_PERC="\${{ steps.collect.outputs.xp_perc }}"
          TOP1="\${{ steps.collect.outputs.top1 }}"
          TOP1_DESC="\${{ steps.collect.outputs.top1_desc }}"
          DATE="\${{ steps.collect.outputs.date }}"

          if [ "$STYLE" = "0" ]; then
            BG="#0f1720"; ACC="#FF2E63"; GRA="#08D9D6"
          elif [ "$STYLE" = "1" ]; then
            BG="#14121b"; ACC="#FFD166"; GRA="#06D6A0"
          elif [ "$STYLE" = "2" ]; then
            BG="#ffffff"; ACC="#1b1b1b"; GRA="#e63946"
          else
            BG="#080808"; ACC="#7C4DFF"; GRA="#00E5FF"
          fi

          cat <<EOF > chaos/\${USER}-chaos.svg
<svg xmlns="http://www.w3.org/2000/svg" width="460" height="220">
  <style>
    .title { font-size:16px; font-weight:bold; fill:\${ACC}; }
    .text { font-size:11px; fill:\${GRA}; }
    .small { font-size:9px; fill:#aaa; }
  </style>
  <rect width="100%" height="100%" fill="\${BG}" rx="16"/>
  <image href="\${AVATAR}" x="16" y="18" width="68" height="68" clip-path="circle(34px at 50% 50%)"/>
  <text x="100" y="36" class="title">\${LOGIN}</text>
  <text x="100" y="56" class="small">\${NAME}</text>
  <text x="100" y="74" class="text">\${BIO}</text>
  <text x="18" y="150" class="text">Repos: \${REPOS} | Followers: \${FOLLOWERS} | Stars: \${STARS}</text>
  <text x="18" y="170" class="small">Commits: \${COMMITS} | PRs: \${PRS} | Issues: \${ISSUES}</text>
  <text x="18" y="188" class="text">Top Repo: \${TOP1} â€” \${TOP1_DESC}</text>
  <rect x="300" y="28" width="140" height="12" rx="6" fill="#333" opacity="0.5"/>
  <rect x="300" y="28" width="\$((140 * \${XP_PERC} / 100))" height="12" rx="6" fill="\${ACC}"/>
  <text x="370" y="22" class="small" text-anchor="middle">LV.\${LEVEL} â€¢ XP \${XP}</text>
  <text x="230" y="210" text-anchor="middle" class="small">æ›´æ–°æ—¥: \${DATE} â€¢ CHAOS v1</text>
</svg>
EOF

      - name: ðŸ’¾ Commit e Push
        run: |
          git config user.name "github-actions"
          git config user.email "github-actions@github.com"
          git add chaos/
          git commit -m "ðŸ§¨ Chaos Card atualizado para \${{ github.event.inputs.usuario }}" || echo "Nada a commitar"
          git push
`;
    }

    previewYAML() {
        this.collectFormData();
        if (!this.validateForm()) return;
        const yaml = this.generateChaosYAML();
        document.getElementById('preview').textContent = yaml;
        this.showToast('âœ… YAML gerado com sucesso!');
    }

    downloadYAML() {
        const yaml = this.generateChaosYAML();
        const blob = new Blob([yaml], { type: 'text/yaml' });
        const link = document.createElement('a');
        link.href = URL.createObjectURL(blob);
        link.download = `${this.formData.workflowName}.yml`;
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
        this.showToast('âš¡ YAML baixado!');
    }

    showToast(msg, type = 'success') {
        const toast = document.getElementById('toast');
        if (!toast) return alert(msg);
        toast.textContent = msg;
        toast.className = 'toast ' + type + ' show';
        setTimeout(() => toast.classList.remove('show'), 4000);
    }
}

// Inicializa
const chaosGen = new ChaosWorkflowGenerator();

function previewChaos() { chaosGen.previewYAML(); }
function downloadChaos() { chaosGen.downloadYAML(); }

document.addEventListener('DOMContentLoaded', () => {
    document.getElementById('username')?.focus();
});
