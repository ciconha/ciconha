name: Ciconha

on:
  workflow_dispatch:
    inputs:
      usuario:
        description: "Nome do usu√°rio (sem @)"
        required: true
        default: "ciconha"

permissions:
  contents: write

jobs:
  gerar-card:
    runs-on: ubuntu-latest

    steps:
      - name: Clonar reposit√≥rio
        uses: actions/checkout@v4

      - name: Instalar depend√™ncias
        run: |
          sudo apt-get update
          sudo apt-get install -y librsvg2-bin curl jq

      - name: Buscar dados do GitHub
        id: dados
        run: |
          USER=${{ github.event.inputs.usuario }}
          echo "üîç Buscando dados de $USER"

          DATA=$(curl -s https://api.github.com/users/$USER)
          LOGIN=$(echo "$DATA" | jq -r .login)
          AVATAR=$(echo "$DATA" | jq -r .avatar_url)
          REPOS=$(echo "$DATA" | jq -r .public_repos)
          FOLLOWERS=$(echo "$DATA" | jq -r .followers)

          COMMITS=$(curl -s "https://api.github.com/search/commits?q=author:$USER" -H "Accept: application/vnd.github.cloak-preview" | jq -r .total_count)
          PRS=$(curl -s "https://api.github.com/search/issues?q=author:$USER+type:pr" | jq -r .total_count)
          ISSUES=$(curl -s "https://api.github.com/search/issues?q=author:$USER+type:issue" | jq -r .total_count)

          XP=$(( (COMMITS + PRS + ISSUES) / 5 ))
          LEVEL=$(( XP / 100 + 1 ))
          DATE=$(date +"%YÂπ¥%mÊúà%dÊó•")

          TOP1="Python"
          TOP1_DESC="An√°lise e automa√ß√£o"
          FILLED=$(( XP / 2 ))
          [ $FILLED -gt 360 ] && FILLED=360

          echo "LOGIN=$LOGIN" >> $GITHUB_ENV
          echo "AVATAR=$AVATAR" >> $GITHUB_ENV
          echo "REPOS=$REPOS" >> $GITHUB_ENV
          echo "FOLLOWERS=$FOLLOWERS" >> $GITHUB_ENV
          echo "COMMITS=$COMMITS" >> $GITHUB_ENV
          echo "PRS=$PRS" >> $GITHUB_ENV
          echo "ISSUES=$ISSUES" >> $GITHUB_ENV
          echo "XP=$XP" >> $GITHUB_ENV
          echo "LEVEL=$LEVEL" >> $GITHUB_ENV
          echo "DATE=$DATE" >> $GITHUB_ENV
          echo "TOP1=$TOP1" >> $GITHUB_ENV
          echo "TOP1_DESC=$TOP1_DESC" >> $GITHUB_ENV
          echo "FILLED=$FILLED" >> $GITHUB_ENV

      - name: Gerar SVG personalizado
        run: |
          USER=${{ github.event.inputs.usuario }}
          mkdir -p japan

          cat << 'EOF' > "japan/${USER}-card.svg"
<svg xmlns="http://www.w3.org/2000/svg" width="920" height="560">
  <style>
    .bg { fill: #000 }
    .moon { fill: #b70a0a }
    .title { font: bold 36px 'Noto Sans JP', sans-serif; fill: #fff }
    .sub { font: 18px 'Noto Sans JP', sans-serif; fill: #ccc }
    .mono { font: 16px 'Courier New', monospace; fill: #fff }
    .small { font: 14px 'Noto Sans JP', sans-serif; fill: #bbb }
    .bar-bg { fill: #222 }
    .bar-fill { fill: #b70a0a }
  </style>
  <rect width="100%" height="100%" class="bg" rx="28"/>
  <g transform="translate(720,120)">
    <circle cx="0" cy="0" r="100" class="moon"/>
    <text x="0" y="-10" font-size="32" fill="#fff" text-anchor="middle">Á∫íÈßÜËÄÖ</text>
    <text x="0" y="24" font-size="16" fill="#fff" text-anchor="middle">ËÅ∑Ê•≠: „Ç≥„Éº„Éâ„ÅÆÂÜíÈô∫ËÄÖ</text>
  </g>
  <defs><clipPath id="avatarClip"><circle cx="120" cy="120" r="60"/></clipPath></defs>
  <rect x="30" y="60" width="180" height="180" rx="18" fill="#111"/>
  <image href="__AVATAR__" x="60" y="90" width="120" height="120" clip-path="url(#avatarClip)"/>
  <text x="240" y="110" class="title">„É¶„Éº„Ç∂„ÉºÔºö__LOGIN__</text>
  <text x="240" y="150" class="sub">Áã¨Á´ã ‚Ä¢ ÂÄã‰∫∫ÈñãÁô∫ËÄÖ</text>
  <text x="240" y="190" class="small">„É™„Éù„Ç∏„Éà„É™Ôºö__REPOS__</text>
  <text x="240" y="220" class="small">„Éï„Ç©„É≠„ÉØ„ÉºÔºö__FOLLOWERS__</text>
  <text x="240" y="260" class="small">„Ç≥„Éü„ÉÉ„Éà / PR / Ë™≤È°åÔºö__COMMITS__ / __PRS__ / __ISSUES__</text>
  <text x="240" y="300" class="small">„Éà„ÉÉ„Éó: __TOP1__ ‚Äî __TOP1_DESC__</text>
  <rect x="60" y="340" width="360" height="18" rx="9" class="bar-bg"/>
  <rect x="60" y="340" width="__FILLED__" height="18" rx="9" class="bar-fill"/>
  <text x="240" y="380" class="mono" text-anchor="middle">LV.__LEVEL__ ‚Ä¢ ÁµåÈ®ìÂÄ§ __XP__</text>
  <text x="760" y="520" class="small" text-anchor="end">__DATE__</text>
</svg>
EOF

          svgfile="japan/${USER}-card.svg"
          sed -i "s|__AVATAR__|${AVATAR}|g" "$svgfile"
          sed -i "s|__LOGIN__|${LOGIN}|g" "$svgfile"
          sed -i "s|__REPOS__|${REPOS}|g" "$svgfile"
          sed -i "s|__FOLLOWERS__|${FOLLOWERS}|g" "$svgfile"
          sed -i "s|__COMMITS__|${COMMITS}|g" "$svgfile"
          sed -i "s|__PRS__|${PRS}|g" "$svgfile"
          sed -i "s|__ISSUES__|${ISSUES}|g" "$svgfile"
          sed -i "s|__XP__|${XP}|g" "$svgfile"
          sed -i "s|__LEVEL__|${LEVEL}|g" "$svgfile"
          sed -i "s|__DATE__|${DATE}|g" "$svgfile"
          sed -i "s|__TOP1__|${TOP1}|g" "$svgfile"
          sed -i "s|__TOP1_DESC__|${TOP1_DESC}|g" "$svgfile"
          sed -i "s|__FILLED__|${FILLED}|g" "$svgfile"

          echo "‚úÖ SVG criado: $svgfile"

      - name: Commit e Push
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          git config user.name "github-actions"
          git config user.email "github-actions@github.com"
          git add japan/
          git commit -m "üà∂ Gerado card japon√™s para ${{ github.event.inputs.usuario }}" || echo "‚ÑπÔ∏è Nenhuma mudan√ßa"
          git push
