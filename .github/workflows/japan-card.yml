name: Ciconha Cyber Profile Card üåÉ

on:
  workflow_dispatch:
    inputs:
      usuario:
        description: "Nome do usu√°rio (sem @)"
        required: true
        default: "ciconha"

permissions:
  contents: write

jobs:
  gerar-card-cyber:
    runs-on: ubuntu-latest

    steps:
      - name: ‚öôÔ∏è Clonar reposit√≥rio
        uses: actions/checkout@v4

      - name: üì¶ Instalar Depend√™ncias
        run: |
          sudo apt-get update
          # librsvg2-bin para convers√£o SVG -> PNG
          sudo apt-get install -y librsvg2-bin curl jq fonts-noto-cjk

      - name: üîç Buscar Dados & Calcular XP
        id: dados
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          USER="${{ github.event.inputs.usuario }}"
          echo "üîç Processando dados para o usu√°rio: $USER"

          # --- 1. Busca de Perfil ---
          DATA=$(curl -s "https://api.github.com/users/$USER" -H "Authorization: token $GH_TOKEN")
          
          if [[ "$(echo "$DATA" | jq -r .message)" == "Not Found" ]]; then
            echo "::error::Usu√°rio '$USER' n√£o encontrado no GitHub."
            exit 1
          fi

          LOGIN=$(echo "$DATA" | jq -r .login)
          AVATAR=$(echo "$DATA" | jq -r .avatar_url)
          REPOS=$(echo "$DATA" | jq -r .public_repos)
          FOLLOWERS=$(echo "$DATA" | jq -r .followers)

          # --- 2. Busca de Estat√≠sticas ---
          STATS_HEADER="Authorization: token $GH_TOKEN"
          
          COMMITS=$(curl -s "https://api.github.com/search/commits?q=author:$USER" -H "$STATS_HEADER" -H "Accept: application/vnd.github.cloak-preview" | jq -r .total_count)
          PRS=$(curl -s "https://api.github.com/search/issues?q=author:$USER+type:pr" -H "$STATS_HEADER" | jq -r .total_count)
          ISSUES=$(curl -s "https://api.github.com/search/issues?q=author:$USER+type:issue" -H "$STATS_HEADER" | jq -r .total_count)

          # --- 3. C√°lculos ---
          XP=$(( (COMMITS + PRS + ISSUES) / 5 ))
          LEVEL=$(( XP / 100 + 1 ))
          DATE=$(date +"%YÂπ¥%mÊúà%dÊó•")
          
          TOP1="Rust" # Estilo Cyberpunk/Performance
          TOP1_DESC="Sistemas de Alta Performance"
          
          FILLED=$(( XP / 2 ))
          [ $FILLED -gt 360 ] && FILLED=360 # M√°ximo de 360px para a barra

          # --- 4. Exportar para GITHUB_ENV ---
          echo "LOGIN=$LOGIN" >> $GITHUB_ENV
          echo "AVATAR=$AVATAR" >> $GITHUB_ENV
          echo "REPOS=$REPOS" >> $GITHUB_ENV
          echo "FOLLOWERS=$FOLLOWERS" >> $GITHUB_ENV
          echo "COMMITS=$COMMITS" >> $GITHUB_ENV
          echo "PRS=$PRS" >> $GITHUB_ENV
          echo "ISSUES=$ISSUES" >> $GITHUB_ENV
          echo "XP=$XP" >> $GITHUB_ENV
          echo "LEVEL=$LEVEL" >> $GITHUB_ENV
          echo "DATE=$DATE" >> $GITHUB_ENV
          echo "TOP1=$TOP1" >> $GITHUB_ENV
          echo "TOP1_DESC=$TOP1_DESC" >> $GITHUB_ENV
          echo "FILLED=$FILLED" >> $GITHUB_ENV
          
      - name: üé® Gerar SVG Cyberpunk (Base para PNG)
        run: |
          USER="${{ github.event.inputs.usuario }}"
          mkdir -p japan
          svg_path="japan/${USER}-card.svg"

          # SVG com Estilo Cyberpunk/Neon (Lua Vermelha, Grids)
          cat << 'EOF' > "$svg_path"


     



          
          # --- Substitui√ß√£o CR√çTICA e SEGURA (Delimitador |) ---
          sed -i "s|__AVATAR__|$AVATAR|g" "$svg_path"
          sed -i "s|__LOGIN__|$LOGIN|g" "$svg_path"
          sed -i "s|__REPOS__|$REPOS|g" "$svg_path"
          sed -i "s|__FOLLOWERS__|$FOLLOWERS|g" "$svg_path"
          sed -i "s|__COMMITS__|$COMMITS|g" "$svg_path"
          sed -i "s|__PRS__|$PRS|g" "$svg_path"
          sed -i "s|__ISSUES__|$ISSUES|g" "$svg_path"
          sed -i "s|__XP__|$XP|g" "$svg_path"
          sed -i "s|__LEVEL__|$LEVEL|g" "$svg_path"
          sed -i "s|__DATE__|$DATE|g" "$svg_path"
          sed -i "s|__TOP1__|$TOP1|g" "$svg_path"
          sed -i "s|__TOP1_DESC__|$TOP1_DESC|g" "$svg_path"
          sed -i "s|__FILLED__|$FILLED|g" "$svg_path"

          echo "‚úÖ SVG Cyberpunk Criado em: $svg_path"

      - name: üñºÔ∏è Converter SVG para PNG de Alta Qualidade
        run: |
          USER="${{ github.event.inputs.usuario }}"
          SVG_FILE="japan/${USER}-card.svg"
          PNG_FILE="japan/${USER}-card.png"
          
          # Convers√£o para PNG com boa resolu√ß√£o (Zoom 3x)
          echo "Convertendo $SVG_FILE para $PNG_FILE..."
          rsvg-convert -w 800 -h 450 --zoom 3 -o "$PNG_FILE" "$SVG_FILE"
          
          echo "‚úÖ PNG final criado: $PNG_FILE"


      - name: üíæ Commit e Push do PNG
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"
          
          # Adiciona APENAS o PNG ao commit, removendo o SVG (o SVG n√£o √© mais necess√°rio)
          git add japan/*.png
          # Remove o SVG se ele foi criado, para n√£o commitar
          git rm --cached japan/*.svg || true 
          
          git commit -m "‚ú® Gerado Cyber Profile Card PNG para ${{ github.event.inputs.usuario }}" || echo "‚ÑπÔ∏è Nenhuma altera√ß√£o para commitar."
          git push
